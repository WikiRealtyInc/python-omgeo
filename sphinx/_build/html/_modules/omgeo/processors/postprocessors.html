
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>omgeo.processors.postprocessors &mdash; python-omgeo 1.5.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.5.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="python-omgeo 1.5.0 documentation" href="../../../index.html" />
    <link rel="up" title="omgeo.processors" href="../processors.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">python-omgeo 1.5.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../omgeo.html" >omgeo</a> &raquo;</li>
          <li><a href="../processors.html" accesskey="U">omgeo.processors</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for omgeo.processors.postprocessors</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">omgeo.processors</span> <span class="kn">import</span> <span class="n">PostProcessor</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">attrgetter</span>

<div class="viewcode-block" id="LocatorFilter"><a class="viewcode-back" href="../../../index.html#omgeo.processors.postprocessors.LocatorFilter">[docs]</a><span class="k">class</span> <span class="nc">LocatorFilter</span><span class="p">(</span><span class="n">PostProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PostProcessor used to ditch results with lousy locators.</span>

<span class="sd">    Arguments:</span>
<span class="sd">    ==========</span>
<span class="sd">    good_locators   --  A list of locators to</span>
<span class="sd">                        accept results from (default [])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">good_locators</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A list of Candidate.locator values that are good enough for what we need.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">good_locators</span><span class="o">=</span><span class="p">[]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_helper</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">[:]:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">locator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_locators</span><span class="p">:</span>
                <span class="c">#TODO: search string, i.e. find &quot;EU_Street_Name&quot; in &quot;EU_Street_Name.GBR_StreetName&quot;</span>
                <span class="n">candidates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
         
        <span class="k">return</span> <span class="n">candidates</span>
</div>
<div class="viewcode-block" id="LocatorSorter"><a class="viewcode-back" href="../../../index.html#omgeo.processors.postprocessors.LocatorSorter">[docs]</a><span class="k">class</span> <span class="nc">LocatorSorter</span><span class="p">(</span><span class="n">PostProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PostProcessor used to sort by locators</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ordered_locators</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A list of Candidate.locator values placed in the desired order.</span>
<span class="sd">    </span>
<span class="sd">    *Examples*:</span>

<span class="sd">        [&#39;rooftop&#39;, &#39;address&#39;, &#39;street&#39;, &#39;city&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ordered_locators</span><span class="o">=</span><span class="p">[]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_helper</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
    
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unordered_candidates</span><span class="p">):</span>
        <span class="n">ordered_candidates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># make a new list of candidates in order of ordered_locators</span>
        <span class="k">for</span> <span class="n">locator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordered_locators</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">uc</span> <span class="ow">in</span> <span class="n">unordered_candidates</span><span class="p">[:]:</span>
                <span class="k">if</span> <span class="n">uc</span><span class="o">.</span><span class="n">locator</span> <span class="o">==</span> <span class="n">locator</span><span class="p">:</span>
                    <span class="n">ordered_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uc</span><span class="p">)</span>
                    <span class="n">unordered_candidates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">uc</span><span class="p">)</span>
        <span class="c"># add all the candidates that are still left</span>
        <span class="c"># (whose locator values are not in ordered_locators)</span>
        <span class="c"># and return the new list</span>
        <span class="k">return</span> <span class="n">ordered_candidates</span> <span class="o">+</span> <span class="n">unordered_candidates</span>
</div>
<div class="viewcode-block" id="AttrRename"><a class="viewcode-back" href="../../../index.html#omgeo.processors.postprocessors.AttrRename">[docs]</a><span class="k">class</span> <span class="nc">AttrRename</span><span class="p">(</span><span class="n">PostProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PostProcessor used to rename the given attribute, with unspecified</span>
<span class="sd">    attributes appearing at the end of the list.</span>

<span class="sd">    Arguments:</span>
<span class="sd">    ==========</span>
<span class="sd">    attr            -- Name of the attribute</span>
<span class="sd">    attr_map        -- Dictionary of old names : new names.</span>
<span class="sd">    exact_match</span>
<span class="sd">    case_sensitive</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">attr_map</span><span class="o">=</span><span class="p">{},</span> <span class="n">exact_match</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">case_sensitive</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_helper</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_cc</span><span class="p">(</span><span class="n">str_</span><span class="p">):</span> <span class="c">#change case</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">case_sensitive</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span> <span class="k">return</span> <span class="n">str_</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">str_</span>      
  
        <span class="n">new_candidates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">[:]:</span>
            <span class="n">attr_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exact_match</span> <span class="ow">is</span> <span class="bp">False</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">_cc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_cc</span><span class="p">(</span><span class="n">attr_val</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_map</span><span class="p">):</span>
                <span class="n">map_key</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_map</span> <span class="k">if</span> <span class="n">_cc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_cc</span><span class="p">(</span><span class="n">attr_val</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">map_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_map</span><span class="p">[</span><span class="n">map_key</span><span class="p">]</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">,</span> <span class="n">map_val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">_cc</span><span class="p">(</span><span class="n">attr_val</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_cc</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_map</span><span class="p">]:</span>
                <span class="n">map_key</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_map</span> <span class="k">if</span> <span class="n">_cc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">_cc</span><span class="p">(</span><span class="n">attr_val</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_map</span><span class="p">[</span><span class="n">map_key</span><span class="p">])</span>
            <span class="n">new_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_candidates</span>
</div>
<div class="viewcode-block" id="UseHighScoreIfAtLeast"><a class="viewcode-back" href="../../../index.html#omgeo.processors.postprocessors.UseHighScoreIfAtLeast">[docs]</a><span class="k">class</span> <span class="nc">UseHighScoreIfAtLeast</span><span class="p">(</span><span class="n">PostProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Limit results to results with at least the given score,</span>
<span class="sd">    if and only if one or more results has, at least, the</span>
<span class="sd">    given score. If no results have at least this score,</span>
<span class="sd">    all of the original results are returned intact.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_score</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_helper</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
        <span class="n">high_score_candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">score</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_score</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">high_score_candidates</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">return</span> <span class="n">high_score_candidates</span>
        <span class="k">return</span> <span class="n">candidates</span>
</div>
<div class="viewcode-block" id="ScoreSorter"><a class="viewcode-back" href="../../../index.html#omgeo.processors.postprocessors.ScoreSorter">[docs]</a><span class="k">class</span> <span class="nc">ScoreSorter</span><span class="p">(</span><span class="n">PostProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PostProcessor class to sort candidate scores.</span>

<span class="sd">    Arguments:</span>
<span class="sd">    ==========</span>
<span class="sd">    reverse  --  Boolean indicating if the scores should be sorted </span>
<span class="sd">                 descending (e.g. 100, 90, 80, ...) (default True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_helper</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s">&#39;score&#39;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttrSorter"><a class="viewcode-back" href="../../../index.html#omgeo.processors.postprocessors.AttrSorter">[docs]</a><span class="k">class</span> <span class="nc">AttrSorter</span><span class="p">(</span><span class="n">PostProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PostProcessor used to sort by a the given attribute, with unspecified</span>
<span class="sd">    attributes appearing at the end of the list.</span>

<span class="sd">    Arguments:</span>
<span class="sd">    ==========</span>
<span class="sd">    ordered_values   --  A list of values placed in the desired order.</span>
<span class="sd">    attr             --  The attribute on which to sort.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ordered_values</span><span class="o">=</span><span class="p">[],</span> <span class="n">attr</span><span class="o">=</span><span class="s">&#39;locator&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_helper</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
    
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unordered_candidates</span><span class="p">):</span>
        <span class="n">ordered_candidates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># make a new list of candidates in order of ordered_values</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordered_values</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">uc</span> <span class="ow">in</span> <span class="n">unordered_candidates</span><span class="p">[:]:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">ordered_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uc</span><span class="p">)</span>
                    <span class="n">unordered_candidates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">uc</span><span class="p">)</span>
        <span class="c"># add all the candidates that are still left</span>
        <span class="c"># and return the new list</span>
        <span class="k">return</span> <span class="n">ordered_candidates</span> <span class="o">+</span> <span class="n">unordered_candidates</span>
</div>
<div class="viewcode-block" id="AttrReverseSorter"><a class="viewcode-back" href="../../../index.html#omgeo.processors.postprocessors.AttrReverseSorter">[docs]</a><span class="k">class</span> <span class="nc">AttrReverseSorter</span><span class="p">(</span><span class="n">PostProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PostProcessor used to sort by the given attributes in reverse order,</span>
<span class="sd">    with unspecified attributes appearing at the end of the list.</span>
<span class="sd">    </span>
<span class="sd">    This is good to use when a list has already been defined in a script</span>
<span class="sd">    and you are too lazy to use the reverse() function, or don&#39;t want</span>
<span class="sd">    to in order to maintain more readable code.</span>

<span class="sd">    Arguments:</span>
<span class="sd">    ==========</span>
<span class="sd">    ordered_values   -- A list of values placed in the reverse </span>
<span class="sd">                        of the desired order.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ordered_values</span><span class="o">=</span><span class="p">[],</span> <span class="n">attr</span><span class="o">=</span><span class="s">&#39;locator&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_helper</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
    
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unordered_candidates</span><span class="p">):</span>
        <span class="n">ordered_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordered_values</span>
        <span class="n">ordered_values</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">sorter</span> <span class="o">=</span> <span class="n">AttrSorter</span><span class="p">(</span><span class="n">ordered_values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sorter</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">unordered_candidates</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttrMigrator"><a class="viewcode-back" href="../../../index.html#omgeo.processors.postprocessors.AttrMigrator">[docs]</a><span class="k">class</span> <span class="nc">AttrMigrator</span><span class="p">(</span><span class="n">PostProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PostProcessor used to migrate the given attribute</span>
<span class="sd">    to another attribute.</span>

<span class="sd">    Arguments:</span>
<span class="sd">    ==========</span>
<span class="sd">    attr_from       -- Name of the input attribute</span>
<span class="sd">    attr_to         -- Name of the input attribute to overwrite</span>
<span class="sd">    attr_map        -- Dictionary of old names : new names.</span>
<span class="sd">    exact_match     -- Boolean</span>
<span class="sd">    case_sensitive  -- Boolean</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_from</span><span class="p">,</span> <span class="n">attr_to</span><span class="p">,</span> <span class="n">attr_map</span><span class="o">=</span><span class="p">{},</span> <span class="n">exact_match</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">case_sensitive</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_helper</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_cc</span><span class="p">(</span><span class="n">str_</span><span class="p">):</span> <span class="c">#change case</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">case_sensitive</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span> <span class="k">return</span> <span class="n">str_</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">str_</span>   

        <span class="n">new_candidates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">[:]:</span>
            <span class="n">from_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_from</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exact_match</span> <span class="ow">is</span> <span class="bp">False</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">_cc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_cc</span><span class="p">(</span><span class="n">from_val</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_map</span><span class="p">):</span>
                <span class="n">map_key</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_map</span> <span class="k">if</span> <span class="n">_cc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_cc</span><span class="p">(</span><span class="n">from_val</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">map_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_map</span><span class="p">[</span><span class="n">map_key</span><span class="p">]</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_to</span><span class="p">,</span> <span class="n">map_val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">_cc</span><span class="p">(</span><span class="n">from_val</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_cc</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_map</span><span class="p">]:</span>
                <span class="n">map_key</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_map</span> <span class="k">if</span> <span class="n">_cc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">_cc</span><span class="p">(</span><span class="n">from_val</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_to</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_map</span><span class="p">[</span><span class="n">map_key</span><span class="p">])</span>
            <span class="n">new_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_candidates</span>
</div>
<div class="viewcode-block" id="AttrFilter"><a class="viewcode-back" href="../../../index.html#omgeo.processors.postprocessors.AttrFilter">[docs]</a><span class="k">class</span> <span class="nc">AttrFilter</span><span class="p">(</span><span class="n">PostProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PostProcessor used to ditch results with unwanted attribute values.</span>

<span class="sd">    Arguments:</span>
<span class="sd">    ==========</span>
<span class="sd">    good_values   --  A list of values whose candidates we will</span>
<span class="sd">                      accept results from (default [])</span>
<span class="sd">    </span>
<span class="sd">    attr          --  The attribute type on which to filter</span>

<span class="sd">    exact_match   --  True if attribute must match a good value exactly.</span>
<span class="sd">                      False if the attribute can be a substring in a</span>
<span class="sd">                      good value. In other words, if our Candidate</span>
<span class="sd">                      attribute is &#39;US_Rooftop&#39; and one of the good_values</span>
<span class="sd">                      is &#39;Rooftop&#39;, we will keep this candidate.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">good_values</span><span class="o">=</span><span class="p">[],</span> <span class="n">attr</span><span class="o">=</span><span class="s">&#39;locator&#39;</span><span class="p">,</span> <span class="n">exact_match</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_helper</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exact_match</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_values</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">gv</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">gv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_values</span><span class="p">)]</span>
</div>
<div class="viewcode-block" id="AttrExclude"><a class="viewcode-back" href="../../../index.html#omgeo.processors.postprocessors.AttrExclude">[docs]</a><span class="k">class</span> <span class="nc">AttrExclude</span><span class="p">(</span><span class="n">PostProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PostProcessor used to ditch results with unwanted attribute values.</span>

<span class="sd">    Arguments:</span>
<span class="sd">    ==========</span>
<span class="sd">    bad_values   --  A list of values whose candidates we will</span>
<span class="sd">                     not accept results from (default [])</span>

<span class="sd">    attr         --  The attribute type on which to filter</span>

<span class="sd">    exact_match  --  True if attribute must match a bad value exactly.</span>
<span class="sd">                     False if the bad value can be a substring of the</span>
<span class="sd">                     attribute value. In other words, if our Candidate</span>
<span class="sd">                     attribute is &#39;Postcode3&#39; and one of the bad values</span>
<span class="sd">                     is &#39;Postcode&#39; because we want something more precise,</span>
<span class="sd">                     like &#39;Address&#39;, we will not keep this candidate.</span>
<span class="sd">                     </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bad_values</span><span class="o">=</span><span class="p">[],</span> <span class="n">attr</span><span class="o">=</span><span class="s">&#39;locator&#39;</span><span class="p">,</span> <span class="n">exact_match</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_helper</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exact_match</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_values</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">bv</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">bv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_values</span><span class="p">)]</span>
</div>
<div class="viewcode-block" id="DupePicker"><a class="viewcode-back" href="../../../index.html#omgeo.processors.postprocessors.DupePicker">[docs]</a><span class="k">class</span> <span class="nc">DupePicker</span><span class="p">(</span><span class="n">PostProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PostProcessor used to choose the best candidate(s)</span>
<span class="sd">    where there are duplicates (or more than one result</span>
<span class="sd">    that is very similar*) among high-scoring candidates,</span>
<span class="sd">    such as an address. </span>

<span class="sd">    * When comparing attribute values, case and commas do not count.</span>

<span class="sd">    Arguments:</span>
<span class="sd">    ==========</span>
<span class="sd">    attr_dupes      -- Property on which to look for duplicates.</span>
<span class="sd">    attr_sort       -- Property on which to sort using ordered_list</span>
<span class="sd">    ordered_list    -- A list of property values, from most desirable</span>
<span class="sd">                       to least desirable.</span>
<span class="sd">    return_clean    -- Boolean indicating whether or not to</span>
<span class="sd">                       homogenize string values into uppercase</span>
<span class="sd">                       without commas.</span>
<span class="sd">    </span>
<span class="sd">    Usage Example:</span>
<span class="sd">    ==============</span>

<span class="sd">    ================ ===== =======</span>
<span class="sd">    match_addr       score locator</span>
<span class="sd">    ---------------- ----- -------  </span>
<span class="sd">    123 N Wood St    90    roof</span>
<span class="sd">    123 S Wood St    90    address</span>
<span class="sd">    123 N WOOD ST    77    address</span>
<span class="sd">    123, S Wood ST   85    roof</span>
<span class="sd">    ================ ===== =======</span>

<span class="sd">    Above, the first two results have the highest scores. We could just</span>
<span class="sd">    use those, because one of the two likely has the correct address.</span>
<span class="sd">    However, the second result does not have the most precise location</span>
<span class="sd">    for 123 S. Wood Street. While the fourth result does not score as</span>
<span class="sd">    high as the first too, it&#39;s locator method is more desirable.</span>
<span class="sd">    Since the addresses are the same, we can assume that the fourth result</span>
<span class="sd">    will provide better data than the second.</span>
<span class="sd">    </span>
<span class="sd">    We can get a narrowed list as described above by running the process()</span>
<span class="sd">    method in the DupePicker() PostProcessor class as follows, assuming</span>
<span class="sd">    that the &quot;candidates&quot; is our list of candidates:</span>

<span class="sd">        dp = DupePicker(</span>
<span class="sd">            attr_dupes=&#39;match_addr&#39;,</span>
<span class="sd">            attr_sort=&#39;locator&#39;,</span>
<span class="sd">            ordered_list=[&#39;rooftop&#39;, &#39;address_point&#39;, &#39;address_range&#39;])</span>

<span class="sd">        return dp.process(candidates)</span>

<span class="sd">    Output:</span>

<span class="sd">    ================ ===== =======</span>
<span class="sd">    match_addr       score locator</span>
<span class="sd">    ---------------- ----- -------  </span>
<span class="sd">    123 N Wood St    90    roof</span>
<span class="sd">    123, S Wood ST   85    roof</span>
<span class="sd">    ================ ===== =======  </span>

<span class="sd">    Output with return_clean=True:</span>

<span class="sd">    ================ ===== =======</span>
<span class="sd">    match_addr       score locator</span>
<span class="sd">    ---------------- ----- -------  </span>
<span class="sd">    123 N WOOD ST    90    roof</span>
<span class="sd">    123 S WOOD ST    85    roof</span>
<span class="sd">    ================ ===== =======  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_dupes</span><span class="p">,</span> <span class="n">attr_sort</span><span class="p">,</span> <span class="n">ordered_list</span><span class="p">,</span> <span class="n">return_clean</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_helper</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">str_</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Returns string in uppercase and free of commas.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">str_</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">str_</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">str_</span>
        
        <span class="c"># if there are no candidates, then there is nothing to do here</span>
        <span class="k">if</span> <span class="n">candidates</span> <span class="o">==</span> <span class="p">[]:</span> <span class="k">return</span> <span class="p">[]</span>
        <span class="n">hi_score</span> <span class="o">=</span> <span class="n">ScoreSorter</span><span class="p">()</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">candidates</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">score</span>
        <span class="n">hi_score_candidates</span> <span class="o">=</span> <span class="n">AttrFilter</span><span class="p">([</span><span class="n">hi_score</span><span class="p">],</span> <span class="s">&#39;score&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>
        <span class="n">new_candidates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">hsc</span> <span class="ow">in</span> <span class="n">hi_score_candidates</span><span class="p">:</span>
            <span class="c"># get candidates with same address, including the current one:</span>
            <span class="n">attr_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_dupes</span>
            <span class="n">attr_match_test_val</span> <span class="o">=</span> <span class="n">cleanup</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">hsc</span><span class="p">,</span> <span class="n">attr_match</span><span class="p">))</span>
            <span class="c"># make a list of candidates that have essentially the same value for attr_match (like 123 Main &amp; 123 MAIN)</span>
            <span class="c">#import IPython; IPython.embed()</span>
            <span class="n">matching_candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">mc</span> <span class="k">for</span> <span class="n">mc</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">if</span> <span class="n">cleanup</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span> <span class="n">attr_match</span><span class="p">))</span> <span class="o">==</span> <span class="n">attr_match_test_val</span><span class="p">]</span>
            <span class="c"># sort them in the desired order so the first one has the best attribute value</span>
            <span class="n">matching_candidates</span> <span class="o">=</span> <span class="n">AttrSorter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ordered_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_sort</span><span class="p">)</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">matching_candidates</span><span class="p">)</span>
            <span class="c"># the best value available can be grabbed from the top result:</span>
            <span class="n">best_attr_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">matching_candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">attr_match</span><span class="p">)</span>
            <span class="c"># now we can filter results that have best_attr_value:</span>
            <span class="n">new_candidates_queue</span> <span class="o">=</span> <span class="n">AttrFilter</span><span class="p">([</span><span class="n">best_attr_value</span><span class="p">],</span> <span class="n">attr_match</span><span class="p">)</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">matching_candidates</span><span class="p">)</span>
            <span class="c"># and append each one to our list of new candidates, if it&#39;s not there already:</span>
            <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="p">[</span><span class="n">nc</span> <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="n">new_candidates_queue</span> <span class="k">if</span> <span class="n">nc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_candidates</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_clean</span><span class="p">:</span>
                    <span class="n">new_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cleanup</span><span class="p">(</span><span class="n">nc</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_candidates</span>
</div>
<div class="viewcode-block" id="GroupBy"><a class="viewcode-back" href="../../../index.html#omgeo.processors.postprocessors.GroupBy">[docs]</a><span class="k">class</span> <span class="nc">GroupBy</span><span class="p">(</span><span class="n">PostProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Groups results by a certain attribute by choosing the</span>
<span class="sd">    first occurrence in the list (this means you will want</span>
<span class="sd">    to sort ahead of time).</span>

<span class="sd">    Arguments:</span>
<span class="sd">    ==========</span>
<span class="sd">    attr   --  The attribute on which to combine results</span>
<span class="sd">               or a list or tuple of attributes where all</span>
<span class="sd">               attributes must match between candidates.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s">&#39;match_addr&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_helper</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">GroupByMultiple</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>
        <span class="n">keepers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c_from_all</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">[:]:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c_from_all</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">matches</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">keepers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
                    <span class="n">candidates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">keepers</span>
    </div>
<div class="viewcode-block" id="GroupByMultiple"><a class="viewcode-back" href="../../../index.html#omgeo.processors.postprocessors.GroupByMultiple">[docs]</a><span class="k">class</span> <span class="nc">GroupByMultiple</span><span class="p">(</span><span class="n">PostProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Groups results by a certain attribute by choosing the</span>
<span class="sd">    first occurrence in the list of candidates </span>
<span class="sd">    (this means you will want to sort ahead of time).</span>

<span class="sd">    Arguments:</span>
<span class="sd">    ==========</span>
<span class="sd">    attrs   --  A list or tuple of attributes on which to combine results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_helper</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
        <span class="n">keepers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c_from_all</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">[:]:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span>
                       <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c_from_all</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">])]</span>
            <span class="k">if</span> <span class="n">matches</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">keepers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
                    <span class="n">candidates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">keepers</span>   
    </div>
<div class="viewcode-block" id="SnapPoints"><a class="viewcode-back" href="../../../index.html#omgeo.processors.postprocessors.SnapPoints">[docs]</a><span class="k">class</span> <span class="nc">SnapPoints</span><span class="p">(</span><span class="n">PostProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Chooses the first of two or more points where they are within the given</span>
<span class="sd">    sphere-based great circle distance.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">    ==========</span>
<span class="sd">    pnt 1       -- (x, y) tuple</span>
<span class="sd">    pnt 2       -- (x, y) tuple    </span>
<span class="sd">    distance    -- maximum distance (in metres) between two points in which</span>
<span class="sd">                   the the first will be kept and the second thrown out</span>
<span class="sd">                   (default 1).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_helper</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
        
    <span class="k">def</span> <span class="nf">_get_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pnt1</span><span class="p">,</span> <span class="n">pnt2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get distance in meters between two lat/long points&quot;&quot;&quot;</span>
        <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span> <span class="o">=</span> <span class="n">pnt1</span>
        <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span> <span class="o">=</span> <span class="n">pnt2</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="mi">6356752</span> <span class="c"># km</span>
        <span class="n">dlat</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lat2</span><span class="o">-</span><span class="n">lat1</span><span class="p">)</span>
        <span class="n">dlon</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lon2</span><span class="o">-</span><span class="n">lon1</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lat1</span><span class="p">))</span> \
            <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lat2</span><span class="p">))</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlon</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlon</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">a</span><span class="p">))</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">c</span>
        <span class="k">return</span> <span class="n">d</span>
        
    <span class="k">def</span> <span class="nf">_points_within_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pnt1</span><span class="p">,</span> <span class="n">pnt2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns true if lat/lon points are within given distance in metres.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_distance</span><span class="p">(</span><span class="n">pnt1</span><span class="p">,</span> <span class="n">pnt2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
        
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
        <span class="n">keepers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c_from_all</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">[:]:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_points_within_distance</span><span class="p">((</span><span class="n">c_from_all</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">c_from_all</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">y</span><span class="p">))]</span>
            <span class="k">if</span> <span class="n">matches</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">keepers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
                    <span class="n">candidates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">keepers</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">python-omgeo 1.5.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../omgeo.html" >omgeo</a> &raquo;</li>
          <li><a href="../processors.html" >omgeo.processors</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012 Azavea.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>